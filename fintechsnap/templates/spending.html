{% extends "base.html" %}
{% load static %}

{% block title %}Spending Insights â€” FinMentor{% endblock %}

{% block content %}
<div class="min-h-screen flex fm-shell bg-[#FAF7F5]">


  <!-- Sidebar -->
  <aside class="w-60 fm-sidebar px-5 py-6">
    <div class="text-xl font-semibold mb-8 text-white">FinMentor</div>

    <nav class="space-y-2 text-sm">
      <a href="{% url 'dashboard' %}" class="fm-sidebar-link">Dashboard</a>
      <a href="{% url 'spending' %}" class="fm-sidebar-link fm-sidebar-link--active">
        Spending Insights
      </a>
      <a href="{% url 'savings' %}" class="fm-sidebar-link">Savings &amp; Goals</a>
      <a href="{% url 'loans_emi' %}" class="fm-sidebar-link">Loans &amp; EMI</a>
      <!--<a href="{% url 'action_plan' %}" class="fm-sidebar-link">Action Plan &amp; What-If</a>-->
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 px-10 py-8">

    <!-- Header -->
    <header class="mb-6">
      <div class="flex items-start justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-wide text-black/80">
            Spending Insights
          </p>
          <h1 class="text-2xl font-semibold text-black">
            See where your money is going
          </h1>
          <p class="text-sm text-black/70 mt-1">
            Category-wise analysis of your monthly expenses
          </p>
        </div>

        <a href="{% url 'input' %}"
           class="inline-flex items-center gap-2 px-4 py-2 text-xs font-semibold
                  text-white bg-indigo-600 rounded-lg shadow-sm
                  hover:bg-indigo-700">
          ðŸ§¾ Edit Financial Profile
        </a>
      </div>
    </header>

    <!-- OPTIONAL: Spending Persona (Rule-based, not ML) -->
    {% if persona %}
    <section class="mb-6 bg-white rounded-xl p-4 shadow-sm">
      <p class="text-xs uppercase text-gray-500">Spending Persona</p>
      <p class="font-semibold mt-1">{{ persona.title }}</p>
      <p class="text-sm text-gray-600 mt-2">
        {{ persona.long_message }}
      </p>
    </section>
    {% endif %}

    <!-- SUMMARY CARDS -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">

      <div class="fm-card p-4">
        <p class="text-xs text-gray-500">Total Monthly Expenses</p>
        <p class="text-2xl font-semibold text-red-600">
          â‚¹{{ monthly_expenses|floatformat:0|default:"0" }}
        </p>
      </div>

      <div class="fm-card p-4">
        <p class="text-xs text-gray-500">Top Spending Category</p>
        <p class="font-semibold">
          {{ top_category_name|default:"N/A" }}
        </p>
        {% if top_category_pct %}
          <p class="text-xs text-gray-500">{{ top_category_pct }}%</p>
        {% endif %}
      </div>

      <div class="fm-card p-4">
        <p class="text-xs text-gray-500">Essentials vs Discretionary</p>
        <p class="font-semibold">
          {{ essentials_pct }}% / {{ discretionary_pct }}%
        </p>
      </div>

      <!-- ML-IMPORTANT FEATURE -->
      <div class="fm-card p-4">
        <p class="text-xs text-gray-500">Expense-to-Income Ratio</p>
        <p class="font-semibold text-red-600">
          {{ expense_income_ratio }}%
        </p>
      </div>

    </section>

    <!-- CHART + TABLE -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Chart -->
      <div class="fm-card p-5">
        <h2 class="font-semibold mb-3">Spending by Category</h2>

        {% if categories %}
          <canvas id="spendingChart" height="280"></canvas>
        {% else %}
          <p class="text-sm text-gray-500">
            No category data available.  
            Update your financial profile to see insights.
          </p>
        {% endif %}
      </div>

      <!-- Table -->
      <div class="fm-card p-5 lg:col-span-2">
        <h2 class="font-semibold mb-3">Category Breakdown</h2>

        <table class="w-full text-sm">
          <thead>
            <tr class="border-b text-gray-500">
              <th class="text-left py-2">Category</th>
              <th class="text-right py-2">Amount (â‚¹)</th>
              <th class="text-right py-2">%</th>
              <th class="text-right py-2">Type</th>
            </tr>
          </thead>
          <tbody>
            {% for cat in categories %}
            <tr class="border-b last:border-0">
              <td class="py-2">{{ cat.name }}</td>
              <td class="py-2 text-right">â‚¹{{ cat.amount }}</td>
              <td class="py-2 text-right">{{ cat.percent }}%</td>
              <td class="py-2 text-right text-xs text-gray-500">
                {{ cat.type }}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="py-4 text-center text-gray-500">
                No data available
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    </section>

  </main>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

{% if categories %}
{{ chart_labels|json_script:"chart-labels" }}
{{ chart_values|json_script:"chart-values" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const canvas = document.getElementById("spendingChart");

  if (canvas) {
    const labels = JSON.parse(
      document.getElementById("chart-labels").textContent
    );
    const values = JSON.parse(
      document.getElementById("chart-values").textContent
    );

    new Chart(canvas, {
      type: "pie",
      data: {
        labels: labels,
        datasets: [{
          data: values
        }]
      },
      options: {
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  }
</script>
{% endif %}
{% endblock %}
